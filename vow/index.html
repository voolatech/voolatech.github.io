<!DOCTYPE html>
<html>
<head>
 <script src="https://code.createjs.com/easeljs-0.8.0.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.16.1/TweenLite.min.js"></script>
</head>
<body>

<p style="display:none;">Select video:
  <select id="selectVideo">
    <option value="video/Animal.mp4" selected>Animal</option>
    <option value="video/Sea.mp4">Sea</option>
    <option value="video/Sizmek.mp4">Sizmek</option>  
  </select>
</p>

<video id="video1" width="480" height="270" style="display: none;">
  <source id="video1Source" src="video/Sizmek.mp4" type='video/mp4'>
</video>

<p>
  Text:<input id="text" type="text" name="name" value="1 2 3 4 5 6 7 8 9"></input>
  Video clip size: <select id="selectSize">
    <option value="480x270" selected>480x270</option>
    <option value="640x360">640x360</option>
    <option value="720x405">720x405</option>
  </select>
  <input id="start" type="submit" value="Click to play & record">
  
</p>

<canvas id="myCanvas" width="480" height="270" style="border:1px solid #d3d3d3; background-color: black;">
Your browser does not support the HTML5 canvas tag.</canvas>

<p>Video clip result(not include audio):</p>
<video id="video2" controls width="480" height="270" autoplay style="border:1px solid #d3d3d3;">
  <source src="" type='video/mp4'>
</video>

<script>

var video1 = document.getElementById("video1");
video1.addEventListener( "loadedmetadata", function (evt) {
  video1.width = video1.videoWidth,
  video1.height = video1.videoHeight;

  initCanvas();

}, false );

var video2 = document.getElementById('video2')
var canvas = document.getElementById("myCanvas");

var text = document.getElementById('text');
var startBtn = document.getElementById('start');

var selectSize = document.getElementById('selectSize');
selectSize.addEventListener('change', onChangeVideoSizeHandler);

var cjsText;
var bitmap;

var mediaSource = new MediaSource();
mediaSource.addEventListener('sourceopen', handleSourceOpen, false);

var mediaRecorder;
var recordedBlobs;
var sourceBuffer;

var stream = canvas.captureStream(); 

function onChangeVideoSizeHandler(evt) {
  var str = selectSize.options[selectSize.selectedIndex].value;
  var arr = str.split('x');

  var width = arr[0];
  var height = arr[1];

  video2.width = canvas.width = width;
  video2.height = canvas.height = height;

  stream = canvas.captureStream(); 

  stage.clear();
  initCanvas();
}

function handleSourceOpen(evt) {
  sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');
}

function handleDataAvailable(evt) {
  if (evt.data && evt.data.size > 0) {
    recordedBlobs.push(evt.data);
  }
}

function handleStop(evt) {
}

// The nested try blocks will be simplified when Chrome 47 moves to Stable
function startRecording() {
  var options = {mimeType: 'video/webm'};
  recordedBlobs = [];
  try {
    mediaRecorder = new MediaRecorder(stream, options);
  } catch (e0) {
    try {
      options = {mimeType: 'video/webm,codecs=vp9'};
      mediaRecorder = new MediaRecorder(stream, options);
    } catch (e1) {
      try {
        options = 'video/vp8'; // Chrome 47
        mediaRecorder = new MediaRecorder(stream, options);
      } catch (e2) {
        return;
      }
    }
  }

  mediaRecorder.onstop = handleStop;
  mediaRecorder.ondataavailable = handleDataAvailable;
  mediaRecorder.start(10); // collect 100ms of data  
}

window.addEventListener('load', initCanvas);

startBtn.addEventListener('click', function(evt) {
	startVideo();
  startRecording();
});

function startVideo() {
	if (text.value == '') {
		return;
	}
	
	cjsText = new createjs.Text(text.value, '24px Arial', 'red');		
  cjsText.x = -cjsText.getMeasuredWidth();
  cjsText.y = canvas.height / 2 - cjsText.getMeasuredHeight() / 2;

  stage.addChild(cjsText);
  TweenLite.to(cjsText, video1.duration, {x: canvas.width});

	video1.play();
};

function initCanvas() {
  stage = new createjs.Stage("myCanvas");
  
  createjs.Ticker.addEventListener("tick", handleTick);
  function handleTick(event) {
     stage.update();
  }

  bitmap = new createjs.Bitmap(video1);

  var bmpWidth = video1.width;
  var bmpHeight = video1.height;

  var scale = canvas.width / bmpWidth;
  if (bmpHeight * scale > canvas.height) {
    scale = canvas.height/ bmpHeight;
  }

  bitmap.scaleX = bitmap.scaleY = scale;

  bitmap.x = canvas.width/2 - (bmpWidth * scale)/ 2;
  bitmap.y = canvas.height/2 - (bmpHeight * scale)/ 2;

  stage.addChild(bitmap);
}

video1.addEventListener("ended", function() {
	mediaRecorder.stop();

  var superBuffer = new Blob(recordedBlobs, {type: 'video/webm'});
  video2.src = window.URL.createObjectURL(superBuffer);

}, false);
 

</script>

</body>
</html>
